var y=Object.defineProperty;var w=(r,t,e)=>t in r?y(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var p=(r,t,e)=>w(r,typeof t!="symbol"?t+"":t,e);import{A as n}from"./config-CfHoVMbv.js";import{D as d}from"./db-bEbbjtoI.js";import{TextSizeManager as f,showToast as T}from"./utils-DkwAXeNx.js";class L{constructor(){p(this,"startTime",Date.now());p(this,"tipInterval",null)}async checkCacheAndLoad(){const t=localStorage.getItem("snabbaLexin_dataReady")==="true",e=localStorage.getItem("snabbaLexin_version");if(t&&e===n.DATA_VERSION){console.log("[Loader] Fast boot - hiding splash immediately");const s=document.getElementById("splashScreen");s&&(s.style.display="none")}try{console.log("[Loader] Initializing DB..."),await d.init();const s=await d.getDataVersion();if(await d.hasCachedData()&&s===n.DATA_VERSION){console.log("[Loader] Returning user - skipping splash, loading from cache...");const l=document.getElementById("splashScreen");l&&(l.style.display="none");const h=await d.getAllWords();window.dictionaryData=h,window.dispatchEvent(new Event("dictionaryLoaded"));return}}catch(s){console.warn("[Loader] IndexedDB cache check failed:",s)}const a=document.getElementById("splashScreen");a&&a.style.display==="none"&&(a.style.display="flex"),this.startSplashUI(),await this.fetchData()}startSplashUI(){this.startTime=Date.now(),console.log("[Loader] Splash UI started"),this.updateProgress(10,"Ansluter... / جاري الاتصال...");const t=n.LOADING_TIPS,e=document.getElementById("splashTip");e&&(e.textContent=t[0],this.tipInterval&&clearInterval(this.tipInterval),this.tipInterval=setInterval(()=>this.rotateTip(),n.SPLASH.TIP_ROTATION_INTERVAL))}updateProgress(t,e){const a=document.getElementById("splashProgressBar"),s=document.getElementById("splashPercent"),o=document.getElementById("splashStatus");a&&(a.style.width=`${t}%`),s&&(s.textContent=`${Math.round(t)}%`),o&&e&&(o.textContent=e)}rotateTip(){const t=n.LOADING_TIPS,e=document.getElementById("splashTip");e&&(e.style.opacity="0",setTimeout(()=>{const a=Math.floor(Math.random()*t.length);e.textContent=t[a],f.apply(e,t[a]),e.style.opacity="1"},300))}async fetchData(){const e=window.location.pathname.includes("/games/")?n.DATA_PATH.games:n.DATA_PATH.root;try{this.updateProgress(20,"Laddar ordbok... / تحميل القاموس..."),console.log(`[Loader] Fetching data from: ${e}`);const a=await fetch(e);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const s=a.body.getReader(),o=[];let c=0;const l=parseInt(a.headers.get("content-length")||"10140024",10);for(;;){const{done:i,value:I}=await s.read();if(i)break;o.push(I),c+=I.length;const u=20+c/l*60;this.updateProgress(u,"Laddar data... / تحميل البيانات...")}this.updateProgress(85,"Bearbetar... / معالجة البيانات...");const h=new Uint8Array(c);let g=0;for(const i of o)h.set(i,g),g+=i.length;const m=JSON.parse(new TextDecoder().decode(h));window.dictionaryData=m,this.updateProgress(95,"Sparar i cache... / جاري الحفظ...");try{await d.saveWords(m),await d.setDataVersion(n.DATA_VERSION)}catch(i){console.warn("[Loader] Cache failed",i)}this.finishLoading()}catch(a){this.handleError(a)}}finishLoading(){this.updateProgress(100,"Klart! / جاهز!"),this.tipInterval&&clearInterval(this.tipInterval);const t=window.dictionaryData,e=document.getElementById("splashWordCount");e&&t&&(e.textContent=t.length.toLocaleString()),localStorage.setItem("snabbaLexin_dataReady","true"),localStorage.setItem("snabbaLexin_version",n.DATA_VERSION);const a=Date.now()-this.startTime,s=document.getElementById("splashScreen"),o=s?Math.max(500,n.SPLASH.MIN_DISPLAY_TIME-a):0;setTimeout(()=>{s&&(s.classList.add("hidden"),setTimeout(()=>s.remove(),600)),window.dispatchEvent(new Event("dictionaryLoaded"))},o)}handleError(t){console.error("[Loader] Fatal Error:",t),this.tipInterval&&clearInterval(this.tipInterval),this.updateProgress(0,"Fel! / خطأ!");const e=t instanceof Error?t.message:String(t);T(`Fel vid laddning: ${e} / خطأ في التحميل: ${e} `,{type:"error",duration:0})}}const A=new L;typeof window<"u"&&A.checkCacheAndLoad();
