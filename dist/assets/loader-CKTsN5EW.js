var w=Object.defineProperty;var I=(r,e,t)=>e in r?w(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var l=(r,e,t)=>I(r,typeof e!="symbol"?e+"":e,t);import{D as d,A as o}from"./db-TWgxRddZ.js";import{TextSizeManager as y}from"./utils-B-9iATqE.js";class T{constructor(){l(this,"startTime",Date.now());l(this,"tipInterval",null)}async checkCacheAndLoad(){try{console.log("[Loader] Initializing DB..."),await d.init();const e=await d.getDataVersion();if(await d.hasCachedData()&&e===o.DATA_VERSION){console.log("[Loader] Returning user - skipping splash, loading from cache...");const s=document.getElementById("splashScreen");s&&(s.style.display="none");const n=await d.getAllWords();window.dictionaryData=n,window.dispatchEvent(new Event("dictionaryLoaded"));return}}catch(e){console.warn("[Loader] IndexedDB cache check failed:",e)}this.startSplashUI(),await this.fetchData()}startSplashUI(){this.startTime=Date.now(),console.log("[Loader] Splash UI started"),this.updateProgress(10,"Ansluter... / جاري الاتصال...");const e=o.LOADING_TIPS,t=document.getElementById("splashTip");t&&(t.textContent=e[0],this.tipInterval&&clearInterval(this.tipInterval),this.tipInterval=setInterval(()=>this.rotateTip(),o.SPLASH.TIP_ROTATION_INTERVAL))}updateProgress(e,t){const a=document.getElementById("splashProgressBar"),s=document.getElementById("splashPercent"),n=document.getElementById("splashStatus");a&&(a.style.width=`${e}%`),s&&(s.textContent=`${Math.round(e)}%`),n&&t&&(n.textContent=t)}rotateTip(){const e=o.LOADING_TIPS,t=document.getElementById("splashTip");t&&(t.style.opacity="0",setTimeout(()=>{const a=Math.floor(Math.random()*e.length);t.textContent=e[a],y.apply(t,e[a]),t.style.opacity="1"},300))}async fetchData(){const t=window.location.pathname.includes("/games/")?o.DATA_PATH.games:o.DATA_PATH.root;try{this.updateProgress(20,"Laddar ordbok... / تحميل القاموس..."),console.log(`[Loader] Fetching data from: ${t}`);const a=await fetch(t);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const s=a.body.getReader(),n=[];let c=0;const m=parseInt(a.headers.get("content-length")||"10140024",10);for(;;){const{done:i,value:u}=await s.read();if(i)break;n.push(u),c+=u.length;const f=20+c/m*60;this.updateProgress(f,"Laddar data... / تحميل البيانات...")}this.updateProgress(85,"Bearbetar... / معالجة البيانات...");const h=new Uint8Array(c);let p=0;for(const i of n)h.set(i,p),p+=i.length;const g=JSON.parse(new TextDecoder().decode(h));window.dictionaryData=g,this.updateProgress(95,"Sparar i cache... / جاري الحفظ...");try{await d.saveWords(g),await d.setDataVersion(o.DATA_VERSION)}catch(i){console.warn("[Loader] Cache failed",i)}this.finishLoading()}catch(a){this.handleError(a)}}finishLoading(){this.updateProgress(100,"Klart! / جاهز!"),this.tipInterval&&clearInterval(this.tipInterval);const e=window.dictionaryData,t=document.getElementById("splashWordCount");t&&e&&(t.textContent=e.length.toLocaleString());const a=Date.now()-this.startTime,s=document.getElementById("splashScreen"),n=s?Math.max(500,o.SPLASH.MIN_DISPLAY_TIME-a):0;setTimeout(()=>{s&&(s.classList.add("hidden"),setTimeout(()=>s.remove(),600)),window.dispatchEvent(new Event("dictionaryLoaded"))},n)}handleError(e){console.error("[Loader] Fatal Error:",e),this.tipInterval&&clearInterval(this.tipInterval),this.updateProgress(0,"Fel! / خطأ!");const t=document.createElement("div");t.style.cssText="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#ef4444;color:white;padding:12px 24px;border-radius:12px;z-index:9999;font-family:sans-serif;",t.textContent="Fel vid laddning. Pröva att ladda om sidan. / خطأ في التحميل.",document.body.appendChild(t)}}const D=new T;typeof window<"u"&&D.checkCacheAndLoad();
