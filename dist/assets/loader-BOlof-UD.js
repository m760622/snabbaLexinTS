var y=Object.defineProperty;var f=(r,e,t)=>e in r?y(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var p=(r,e,t)=>f(r,typeof e!="symbol"?e+"":e,t);import{A as n}from"./config-CfHoVMbv.js";import{D as d}from"./db-bEbbjtoI.js";import{TextSizeManager as w}from"./utils-B-9iATqE.js";class T{constructor(){p(this,"startTime",Date.now());p(this,"tipInterval",null)}async checkCacheAndLoad(){const e=localStorage.getItem("snabbaLexin_dataReady")==="true",t=localStorage.getItem("snabbaLexin_version");if(e&&t===n.DATA_VERSION){console.log("[Loader] Fast boot - hiding splash immediately");const s=document.getElementById("splashScreen");s&&(s.style.display="none")}try{console.log("[Loader] Initializing DB..."),await d.init();const s=await d.getDataVersion();if(await d.hasCachedData()&&s===n.DATA_VERSION){console.log("[Loader] Returning user - skipping splash, loading from cache...");const c=document.getElementById("splashScreen");c&&(c.style.display="none");const h=await d.getAllWords();window.dictionaryData=h,window.dispatchEvent(new Event("dictionaryLoaded"));return}}catch(s){console.warn("[Loader] IndexedDB cache check failed:",s)}const a=document.getElementById("splashScreen");a&&a.style.display==="none"&&(a.style.display="flex"),this.startSplashUI(),await this.fetchData()}startSplashUI(){this.startTime=Date.now(),console.log("[Loader] Splash UI started"),this.updateProgress(10,"Ansluter... / جاري الاتصال...");const e=n.LOADING_TIPS,t=document.getElementById("splashTip");t&&(t.textContent=e[0],this.tipInterval&&clearInterval(this.tipInterval),this.tipInterval=setInterval(()=>this.rotateTip(),n.SPLASH.TIP_ROTATION_INTERVAL))}updateProgress(e,t){const a=document.getElementById("splashProgressBar"),s=document.getElementById("splashPercent"),o=document.getElementById("splashStatus");a&&(a.style.width=`${e}%`),s&&(s.textContent=`${Math.round(e)}%`),o&&t&&(o.textContent=t)}rotateTip(){const e=n.LOADING_TIPS,t=document.getElementById("splashTip");t&&(t.style.opacity="0",setTimeout(()=>{const a=Math.floor(Math.random()*e.length);t.textContent=e[a],w.apply(t,e[a]),t.style.opacity="1"},300))}async fetchData(){const t=window.location.pathname.includes("/games/")?n.DATA_PATH.games:n.DATA_PATH.root;try{this.updateProgress(20,"Laddar ordbok... / تحميل القاموس..."),console.log(`[Loader] Fetching data from: ${t}`);const a=await fetch(t);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const s=a.body.getReader(),o=[];let l=0;const c=parseInt(a.headers.get("content-length")||"10140024",10);for(;;){const{done:i,value:u}=await s.read();if(i)break;o.push(u),l+=u.length;const I=20+l/c*60;this.updateProgress(I,"Laddar data... / تحميل البيانات...")}this.updateProgress(85,"Bearbetar... / معالجة البيانات...");const h=new Uint8Array(l);let g=0;for(const i of o)h.set(i,g),g+=i.length;const m=JSON.parse(new TextDecoder().decode(h));window.dictionaryData=m,this.updateProgress(95,"Sparar i cache... / جاري الحفظ...");try{await d.saveWords(m),await d.setDataVersion(n.DATA_VERSION)}catch(i){console.warn("[Loader] Cache failed",i)}this.finishLoading()}catch(a){this.handleError(a)}}finishLoading(){this.updateProgress(100,"Klart! / جاهز!"),this.tipInterval&&clearInterval(this.tipInterval);const e=window.dictionaryData,t=document.getElementById("splashWordCount");t&&e&&(t.textContent=e.length.toLocaleString()),localStorage.setItem("snabbaLexin_dataReady","true"),localStorage.setItem("snabbaLexin_version",n.DATA_VERSION);const a=Date.now()-this.startTime,s=document.getElementById("splashScreen"),o=s?Math.max(500,n.SPLASH.MIN_DISPLAY_TIME-a):0;setTimeout(()=>{s&&(s.classList.add("hidden"),setTimeout(()=>s.remove(),600)),window.dispatchEvent(new Event("dictionaryLoaded"))},o)}handleError(e){console.error("[Loader] Fatal Error:",e),this.tipInterval&&clearInterval(this.tipInterval),this.updateProgress(0,"Fel! / خطأ!");const t=document.createElement("div");t.style.cssText="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#ef4444;color:white;padding:12px 24px;border-radius:12px;z-index:9999;font-family:sans-serif;",t.textContent="Fel vid laddning. Pröva att ladda om sidan. / خطأ في التحميل.",document.body.appendChild(t)}}const L=new T;typeof window<"u"&&L.checkCacheAndLoad();
