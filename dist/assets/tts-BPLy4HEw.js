const u={audio:null,lastSpokenText:"",cachedSwedishVoice:null,cachedVoices:{},audioUnlocked:!1,timeoutId:null,isPlaying:!1,audioCache:new Map,isIOS:/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,isSafari:/^((?!chrome|android).)*safari/i.test(navigator.userAgent),isAndroid:/Android/i.test(navigator.userAgent),config:{defaultLang:"sv-SE",fallbackLang:"en-US",maxCacheSize:50,timeoutMs:3500,retryAttempts:2},init(){console.log("ðŸ”Š TTSManager initializing...",{isIOS:this.isIOS,isSafari:this.isSafari,isAndroid:this.isAndroid}),this._loadVoices(),window.speechSynthesis&&(window.speechSynthesis.onvoiceschanged=()=>{this._loadVoices()});const e=()=>{this.unlockAudio(),document.removeEventListener("touchstart",e),document.removeEventListener("click",e)};document.addEventListener("touchstart",e,{passive:!0}),document.addEventListener("click",e,{passive:!0}),console.log("ðŸ”Š TTSManager initialized successfully")},_loadVoices(){if(!window.speechSynthesis)return;const e=window.speechSynthesis.getVoices();e.length&&(this.cachedVoices={},e.forEach(t=>{const i=t.lang.substring(0,2);this.cachedVoices[i]||(this.cachedVoices[i]=[]),this.cachedVoices[i].push(t)}),this.cachedSwedishVoice=this._findBestVoice("sv"))},getSpeed(){const e=localStorage.getItem("ttsSpeed");return e?parseFloat(e):.85},setSpeed(e){const t=Math.min(1.5,Math.max(.5,e));localStorage.setItem("ttsSpeed",t.toString());const i=window.showToast;return typeof i=="function"&&i(`Uttalshastighet: ${Math.round(t*100)}% / Ø³Ø±Ø¹Ø© Ø§Ù„Ù†Ø·Ù‚`),t},unlockAudio(){if(!this.audioUnlocked){try{const e=new Audio;e.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA",e.volume=.01,e.play().then(()=>e.pause()).catch(()=>{})}catch{}try{const e=window.AudioContext||window.webkitAudioContext,t=new e,i=t.createOscillator(),s=t.createGain();s.gain.value=0,i.connect(s),s.connect(t.destination),i.start(0),i.stop(.001),setTimeout(()=>t.close(),100)}catch{}if(window.speechSynthesis)try{const e=new SpeechSynthesisUtterance("");e.volume=0,window.speechSynthesis.speak(e),window.speechSynthesis.cancel()}catch{}this.audioUnlocked=!0}},async speak(e,t="sv",i={}){if(!e||e.trim()==="")return;const s=e.replace(/['']/g,"'").trim();if(s===this.lastSpokenText&&this.isPlaying)return;this.lastSpokenText=s;const n=this._normalizeLang(t),a=window.ProgressManager;return typeof a<"u"&&a.trackTTS(s),this.stop(),this.isPlaying=!0,i.onStart&&i.onStart(),this._speakWithProviders(s,n,i)},speakSwedish(e,t={}){return this.speak(e,"sv-SE",t)},speakArabic(e,t={}){return this.speak(e,"ar",t)},async _speakWithProviders(e,t,i){const s=navigator.onLine,n=[{name:"Google TTS",fn:()=>this._playGoogleTTS(e,t,i),requiresOnline:!0},{name:"Local TTS",fn:()=>this._playLocalTTS(e,t,i)},{name:"VoiceRSS",fn:()=>this._playVoiceRSS(e,t,i),requiresOnline:!0}];for(let a=0;a<n.length;a++){const c=n[a];if(!(c.requiresOnline&&!s))try{await c.fn();return}catch(o){console.warn(`ðŸ”Š ${c.name} failed:`,o.message),a===n.length-1&&(this.isPlaying=!1,i.onError&&i.onError(o))}}},_playVoiceRSS(e,t,i={}){return new Promise((s,n)=>{const a="a28d3d026971413cba0c492136085fae",o={"sv-SE":"sv-se",sv:"sv-se","ar-SA":"ar-sa",ar:"ar-sa","en-US":"en-us",en:"en-us"}[t]||"sv-se";this.audio=new Audio;const d=`https://api.voicerss.org/?key=${a}&hl=${o}&src=${encodeURIComponent(e)}&c=MP3&f=44khz_16bit_stereo`;this.audio.src=d,this.audio.volume=i.volume||1;const h=i.speed||this.getSpeed();this.audio.oncanplay=()=>{try{this.audio.playbackRate=h}catch{}},this.audio.onended=()=>{this.isPlaying=!1,i.onEnd&&i.onEnd(),s()},this.audio.onerror=()=>{this.isPlaying=!1,n(new Error("VoiceRSS audio error"))};const r=setTimeout(()=>{this.audio&&(this.audio.readyState<2||this.audio.paused)&&(this.audio.pause(),n(new Error("VoiceRSS timeout")))},this.config.timeoutMs);this.audio.play().then(()=>clearTimeout(r)).catch(n)})},_playGoogleTTS(e,t,i={}){return new Promise((s,n)=>{this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.audio=new Audio;const a=t.substring(0,2),c=`https://translate.google.com/translate_tts?ie=UTF-8&tl=${a}&client=tw-ob&q=${encodeURIComponent(e)}`,o=`https://translate.google.com/translate_tts?ie=UTF-8&tl=${a}&client=gtx&q=${encodeURIComponent(e)}`,d=()=>{this.audio.src=o,this.audio.onerror=()=>{this.isPlaying=!1,n(new Error("Google TTS failed"))},this.audio.play().catch(n)};this.audio.src=this.audioCache.get(c)||c,this.audio.volume=i.volume||1;const h=i.speed||this.getSpeed();this.audio.oncanplay=()=>{try{this.audio.playbackRate=h}catch{}},this.audio.onended=()=>{this.isPlaying=!1,i.onEnd&&i.onEnd(),s()},this.audio.onerror=d,this.timeoutId=setTimeout(()=>{this.audio&&(this.audio.readyState<2||this.audio.paused)&&(this.audio.pause(),n(new Error("Google TTS timeout")))},this.config.timeoutMs),this.audio.play().then(()=>{if(!this.audioCache.has(c)){if(this.audioCache.size>=this.config.maxCacheSize){const r=this.audioCache.keys().next().value;r&&this.audioCache.delete(r)}this.audioCache.set(c,c)}}).catch(d)})},_playLocalTTS(e,t,i={}){return new Promise((s,n)=>{if(!window.speechSynthesis){n(new Error("Local TTS not supported"));return}window.speechSynthesis.cancel();const a=this.isIOS?250:50;setTimeout(()=>{let c=this._prepareTextForSpeech(e,t);const o=new SpeechSynthesisUtterance(c);o.lang=t;const d=i.speed||this.getSpeed();this.isIOS?o.rate=Math.max(.6,d*.75):o.rate=d*.9;const h=()=>{const r=window.speechSynthesis.getVoices(),p=t.substring(0,2);let l=null;if(p==="sv"){const g=["Alva","Klara","Oskar","Svenska"];for(const S of g)if(l=r.find(f=>f.name.includes(S)&&f.lang.includes("sv"))||null,l)break;l||(l=r.find(S=>S.lang.includes("sv"))||null)}else l=this._findBestVoice(p);l&&(o.voice=l),window.speechSynthesis.speak(o)};o.onend=()=>{this.isPlaying=!1,s()},o.onerror=r=>{this.isPlaying=!1,r.error!=="interrupted"?this.isIOS?s():n(r):s()},window.speechSynthesis.getVoices().length===0?(window.speechSynthesis.onvoiceschanged=()=>{h(),window.speechSynthesis.onvoiceschanged=null},setTimeout(h,500)):h()},a)})},_prepareTextForSpeech(e,t){let i=e;return t.startsWith("sv")&&(i=i.replace(/,/g,", ").replace(/\./g,". "),i=i.replace(/(\d+)/g," $1 "),this.isIOS&&!i.match(/[.!?]$/)&&(i=i+".")),t.startsWith("ar")&&(i=i.replace(/ØŒ/g,", ")),i.trim()},_findBestVoice(e){if(e==="sv"&&this.cachedSwedishVoice)return this.cachedSwedishVoice;const t=this.cachedVoices[e]||[];if(!t.length)return null;const i=["Premium","Enhanced","Neural","Natural","Alva","Maja","Astrid","Samantha","Karen","Daniel","Maged","Majed","Tarik"],s=["Compact","eSpeak","Android"];for(const n of i){const a=t.find(c=>c.name.includes(n)&&!s.some(o=>c.name.includes(o)));if(a)return a}return t.find(n=>!s.some(a=>n.name.includes(a)))||t[0]},_normalizeLang(e){return{sv:"sv-SE",ar:"ar-SA",en:"en-US",de:"de-DE",fr:"fr-FR"}[e]||e},stop(){if(this.audio)try{this.audio.pause(),this.audio.currentTime=0}catch{}if(window.speechSynthesis)try{window.speechSynthesis.cancel()}catch{}this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.isPlaying=!1}};function w(e,t="sv"){return u.speak(e,t)}function m(e){return u.speak(e,"sv-SE")}function y(e){return u.speak(e,"ar")}typeof window<"u"&&(window.TTSManager=u,window.speakText=w,window.speakSwedish=m,window.speakArabic=y,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>u.init()):u.init());export{u as T,m as s};
